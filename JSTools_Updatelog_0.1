// ==UserScript==
// @name        JSTools Updatelog
// @namespace        http://tampermonkey.net/
// @version        0.1
// @description        ã€Œã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ„ãƒ¼ãƒ«ä¸€è¦§è¡¨ã€ã®å„ãƒ„ãƒ¼ãƒ«ã®æœ€çµ‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ—¥ä»˜ã‚’å–å¾—
// @author        AmebaBlogUser
// @match        https://ameblo.jp/*
// @icon        https://www.google.com/s2/favicons?sz=64&domain=ameba.jp
// @noframes
// @grant        none
// ==/UserScript==


let date_all=[];

let links=document.querySelectorAll('#entryBody #ambt0 td:first-child a');

for(let k=0; k<links.length; k++){
    let url=links[k].getAttribute('href');
    ajaxInspect(k, url); }



function ajaxInspect(n, url){ // XMLHttpRequestã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    url=url+'?ver='+new Date().getTime(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æŠ‘æ­¢ã—ã¦å–å¾—
    let ajax=new XMLHttpRequest;
    ajax.open('GET', url, true);
    let pub_date;

    ajax.onload=function(){ // ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã®æ“ä½œ
        let tmp_='<div id="tmp_div" style="display: none"></div>';
        if(!document.querySelector('#tmp_div')){
            document.body.insertAdjacentHTML('beforeend', tmp_); }

        let tmp=document.querySelector('#tmp_div');
        if(tmp){
            tmp.innerHTML=ajax.responseText; // å–å¾—ãƒ‡ãƒ¼ã‚¿ã‚’tmpã«å±•é–‹
            let elem=tmp.querySelector('script[type="application/ld+json"]');
            if(elem){
                let elem_data=elem.textContent;
                let data=elem_data.split(',');
                let pub_data=data.filter(function(data_text){
                    return data_text.includes('datePublished'); });

                if(pub_data){
                    pub_date=pub_data.toString().replace(/[^0-9]/g, '').substr(0, 8);
                    pub_date=
                        pub_date.substr(0, 4) +'-'+ pub_date.substr(4, 2) +'-'+ pub_date.substr(6, 2);
                    date_all[n]=pub_date; }}}

        tmp.innerHTML=''; } // å–å¾—ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤

    ajax.send(null); }



setTimeout(()=>{

    let ok=confirm('ğŸ’¢ æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ ğŸ’¢');
    if(ok){
        output(); }

}, 4000);

function output(){
    let write_json=JSON.stringify(date_all);
    let blob=new Blob([write_json], {type: 'application/json'});
    try{
        let a_elem=document.createElement('a');
        a_elem.href=URL.createObjectURL(blob);
        document.body.appendChild(a_elem);
        a_elem.download='js_tools_date.json'; // ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å
        a_elem.click();
        URL.revokeObjectURL(a_elem.href);
        alert("âœ…  ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ\n"+
              "ã€€ã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
    catch(e){
        alert("âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n"+
              "ã€€ã€€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }}

